MSXマガジン標準ミュージックドライバー

[MuSICA]

-ドライバー部 プログラム 仕様書 -

(1)ミュージックドライバーのエントリーについて説明します。

・BGMINI [CE00H]

  ミュージックドライバーを初期化します。このルーチンを実行するまでは、以後のすべてのミュージックドライバーのエントリールーチンを呼び出してはいけません。また、このルーチン実行後、ページ1のスロットを変更してはいけません。変更する必要が発生した場合は、いったん演奏を中断し、割り込み処理ルーチンからNGMDRVを切り離したあとスロットを変更し、再度このルーチンを呼び出してください。

    エントリー : なし
    リターン   : なし
    レジスタ   : すべて

・BGMON [CE03H]

  演奏を開始します。あらかじめBGMDRVを割り込み処理ルーチンに接続しておいてください。割り込み制御はしていません。必要に応じてDIおよびEIを行ってください。

    エントリー : HL=音楽データヘッダー部の先頭アドレス
                  A=繰り返し回数 0～255
                                 (0のとき無限ループ)
    リターン   : なし
    レジスタ   : すべて

・BGMOFF [CE06H]

  演奏を終了します。割り込み制御はしていません。

    エントリー : なし
    リターン   : なし
    レジスタ   : すべて

・BGMDRV [CE09H]

  60分の1のタイマー割り込みを使用して音楽の演奏を行います。ユーザーの割り込み処理ルーチンから呼び出してください。

・BGMTST [CE0CH]

  BGMONにより開始した音楽が演奏中かどうかを調べます。割り込み制御はしていません。

    エントリー : なし
    リターン   : Zフラグが立っていれば終了している
    レジスタ   : AF

・BGMVOL [CE0FH]

  マスターボリュームの書き込み、読み出し、演奏の一時中断、演奏の再開を制御します。マスターボリュームは0から15の16段階で指定でき、0のとき最大となります。特に必要のない場合は常に0で演奏するように心がけてください。割り込み制御はしていません


    エントリー : A=0～15 マスターボリューム書き込み
                 A=16    マスターボリューム読み出し
                 A=17    演奏の一時中断
                 A=18    演奏の再開
    リターン   : 読みだした場合、Aにマスターボリューム値0～15が入る
    レジスタ   : すべて

・BGMSW [CE12H]

  PSGの音楽データを実際にレジスタに書き込むかどうかをチャンネルごとに設定します。ある特定のPSGチャンネルを効果音で使用するとき、効果音の発生が終了するまで音楽演奏データをそのチャンネルのPSGレジスタに書き込まれては困る場合に使用します。割り込み制御はしていません。

    エントリー : A=00000PPP
                 bit0=PSG チャンネルA
                 bit1=PSG チャンネルB
                 bit2=PSG チャンネルC
                 対応するビットが0のときオン、1のときオフとなります。
                 上位5ビットは必ず0を設定してください。
    リターン   : なし
    レジスタ   : すべて

(2) ミュージックドライバーのワークエリアについて説明します。
[ ]内はそのアドレスとバイト数です。

  ワークエリアの読み出しは可能ですが、書き込んだ場合の動作の保証はありません。またミュージックドライバーの状態を知る必要はある場合は、直接ワークエリアを見ず、上記のエントリールーチンを使用することをおすすめします。

---
  ※ 追記：ver1.02ではアドレスが異なるようです。
         当方で調べて分かったものはアドレスを追記しています。
---


・FMSLOT [CE15H,1] → ver1.02 : [CE97H,1]

  BGMINIを呼び出した時のMSX-MUSICのスロット番号が入ります。MSX-MUSICがない場合0となります。

・SCSLOT [CE16H,1] → ver1.02 : [CE98H,1]

  BGMINIを呼び出した時のSCCカートリッジのスロット番号が入ります。SCCカートリッジがない場合0となります。

・P1SLOT [CE17H,1] → ver1.02 : [CE99H,1]

  BGMINIを呼び出した時のページ1のメインRAMのスロット番号が入ります。

・MSTVOL [CE18H,1] → ver1.02 : [CE9AH,1]

  マスターボリュームの値を示します。

・DRV.ON [CE19H,1] → ver1.02 : [CE9BH,1]

  0なら演奏していない、1なら演奏中を示します。

・DATADD [CE1AH,2] → ver1.02 : [CE9CH,2]

  現在演奏している音楽データのヘッダーデータ部の先頭番地を示します。

---
  ※ 追記：演奏開始後にこのアドレスを書き換えると、イントロ→メインループのようなことが出来る。
---

・PRTFLG [CE1CH,1] → ver1.02 : [CE9EH,1]

  残りの演奏回数を示します。

(3) ミュージックドライバー使用上の注意事項

  BGMINIによりミュージックドライバーを初期化したあとは、ページ1のスロットを変更してはいけません。変更する必要が発生した場合、いったんドライバーを割り込み処理ルーチンより切り離し、スロットを変更後、再度BGMINIを呼び出してください。

  BGMINIをのぞくすべてのエントリールーチンでは、割り込み制御命令(DI、EI)を実行していません。エントリールーチンを呼び出す前後で、必要に応じてDI、EIを行ってください。

(例)

        DI                                      ;割り込み禁止
        LD HL,システムフック保存場所の先頭番地  ;フック切り離し
        LD DE,0FD9FH
        LD BC,5
        LDIR
        LD A,演奏回数                           ;エントリー呼び出し
        LD HL,ミュージックデータ先頭番地
        CALL BGMON
        LD A,0C3H
        LD HL,ユーザー割り込みルーチン
        LD (0FD9FH+0),A
        LD (0FD9FH+1),HL
        EI                                      ;割り込み許可


---
おまけ情報：

SCCスロットを強制指定したい場合（ver1.02用）

プログラムを書き換えてSCC走査結果を固定する

A=SCCカートリッジのSLOT番号
POKE&HD053,&H3E:POKE&HD054,A:POKE&HD055,&H32:POKE&HD056,&H98:POKE&HD057,&HCE:POKE&HD058,0

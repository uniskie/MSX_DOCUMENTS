- - -

# FM-BIOS ENTRY

## ROMヘッダ

4018Hに"OPLL" (4バイト)があったらFM-BIOS ROM。

## FM-BIOS

| エントリ  | WRTOPL  (4110H)
|:---------:|:----------------|
|   機能    | OPLLレジスタへデータを書き込みます。
|   入力    | A＝OPLLのレジスタ番号
|           | E＝書き込むデータ
|   出力    | なし
| レジスタ  | なし
|   解説    | Aレジスタで指定した番号のOPLLレジスタに、Eレジスタの内容を書き込みます。
|           | このエントリルーチン内では、割り込み禁止・解除をしていないので、必要に応じてDI、EIを行う必要があります。

| エントリ  | INIOPL  (4113H)
|:---------:|:----------------|
|   機能    | FM BIOSの環境を整えます。
|   入力    | HL＝ワークエリアの先頭アドレス（偶数）
|   出力    | なし
| レジスタ  | すべて
|   解説    | HLレジスタで指定されたアドレス(偶数)に、FM BIOSで使用するワークエリアを設定し、全てのFM BIOS用のワークエリアおよびOPLLレジスタを初期化します。
|           | ワークエリアの先頭アドレス(偶数)は、【SLTWRK(0FD09H～)】に格納されます。
|           | 指定されたアドレスがRAMでない場合は動作保証しません。
|           | FM BIOSをコールするときは、最初にINIOPLを呼び出さなくてはなりません。
|           | このルーチンを1度も呼び出さずに、他のエントリルーチンを呼び出したときは、正常には動作しません。
|           | EI状態で戻ります。 
| 注意事項  | INIOPLはENASLTを使用してページ1を他のスロットに切り替え、複数のFM-BIOSが存在するかどうか調べます。
|           | そのため、拡張スロットの状態が呼び出し前と異なる状態で帰って来ることがあります。
|           | I/Oポート(A8H)のページ1の基本スロットと、そのスロットの拡張スロットレジスタ(FFFFh)のうち、最低限、拡張スロット選択レジスタを元に戻す必要があります。
|           | 例）スロット0-0にBASIC、スロット1～3にFM BIOSがある場合などはUSR関数からINIOPLを呼び出すとBASICに戻れずに暴走します。

| エントリ  | MSTART  (4116H)
|:---------:|:----------------|
|   機能    | 演奏開始
|   入力    | HL＝ミュージックデータの先頭アドレス
|           | A＝演奏回数
|           | 0  =  無限
|           | 1～254=くり返し回数の指定
|           | 255=動作保証無し
|   出力    | なし
| レジスタ  | すべて
|   解説    | HLレジスタで指定されたアドレスにあるミュージックデータを演奏開始します。
|           | （OPLDRVを割り込みから呼ぶ様にしておかなければ演奏されません。）
|           | EI状態で戻ります。

| エントリ  | MSTOP  (4119H)
|:---------:|:----------------|
|   機能    | 演奏停止
|   入力    | なし
|   出力    | なし
| レジスタ  | すべて
|   解説    | EI状態で戻ります。

| エントリ  | RDDATA  (411CH)
|:---------:|:----------------|
|   機能    | ROM上の音色データを得る
|   入力    | HL＝データを格納するアドレス
|           | A＝音色番号（0～63）
|   出力    | なし
| レジスタ  | F
|   解説    | HLレジスタで指定したアドレスから8バイトの空きエリアが必要です。
|           | HLレジスタで指定したアドレスからOPLLレジスタの0～7の形で値が順に格納されます。

| エントリ  | OPLDRV  (411FH)
|:---------:|:----------------|
|   機能    | OPLLドライバーエントリー
|   入力    | なし
|   出力    | なし
| レジスタ  | なし
|   解説    | INIOPLコール後 H.TIMIフックから呼び出します。
|           | INIOPLコール前の動作は保証できません。

| エントリ  | TSTBGM  (4122H)
|:---------:|:----------------|
|   機能    | 演奏状態を得る
|   入力    | なし
|   出力    | A＝0：演奏終了
|           | 0以外：演奏中
| レジスタ  | AF

---

# FM-BIOS MUSIC DATA

## メロディ6音+リズム構成のヘッダ

| adr. | value          | size    | desc. 
|------|----------------|---------|-------|
| +00H | 0EH            | 1バイト | mode  
| +01H | 00H            | 1バイト | blank 
| +02H | CH1 オフセット | 2バイト | 
| +04H | CH2 オフセット | 2バイト | 
| +06H | CH3 オフセット | 2バイト | 
| +08H | CH4 オフセット | 2バイト | 
| +0AH | CH5 オフセット | 2バイト | 
| +0CH | CH6 オフセット | 2バイト | 
| +0EH | データ本体     |         | 


## メロディ9音構成のヘッダ

| adr. | value          | size    | desc. 
|------|----------------|---------|-------|
| +00H | 12H            | 1バイト | mode  
| +01H | 00H            | 1バイト | blank 
| +02H | CH1 オフセット | 2バイト | 
| +04H | CH2 オフセット | 2バイト | 
| +06H | CH3 オフセット | 2バイト | 
| +08H | CH4 オフセット | 2バイト | 
| +0AH | CH5 オフセット | 2バイト | 
| +0CH | CH6 オフセット | 2バイト | 
| +0EH | CH7 オフセット | 2バイト | 
| +10H | CH8 オフセット | 2バイト | 
| +12H | CH9 オフセット | 2バイト | 
| +14H | データ本体     |         | 

## データ本体

### メロディ部(FM部)

| value      | 意味         | 補足
|------------|--------------|----------------------------------------------------------------------|
|  00H       | 休符         | 続く1バイトが音長。<br> 音長が0FFHのときはさらに続く1バイトも音長に加算。
|  01H～ 5FH | 音程         | 続く1バイトが音長。<br> 音長が0FFHのときはさらに続く1バイトも音長に加算。
|  60H～ 6FH | 音量         | この値から60Hを引いた値が、音量として使用される。
|  70H～ 7FH | 音色         | この値から70Hを引いた値が、音色番号として使用される。
|  80H, 81H  | サスティン   | 80HでサスティンOFF。81HでサスティンON。
|  82H       | 拡張音色     | 続く1バイトの値(0～63)がROMの内蔵音色番号。
|  83H       | ユーザー音色 | 続く2バイトの値が音色データ先頭アドレス。
|  84H       | レガートオフ | 音を音符毎に切る。
|  85H       | レガートオン | 音を切らずにつなぐ。
|  86H       | Q指定        | 続く1バイト(1～8)で指定。（レガートオン時は、Q指定を無視）
|  87H～0FEH | 未使用       | 
|  0FFH      | 終了         | チャンネル毎のデータの終了コード。

### リズム部

```
 BIT |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
---- |-----|-----|-----|-----|-----|-----|-----|-----|
     |  V  |  0  |  1  |  B  |  S  |  T  |  C  |  H  |
```

| ビット    | 意味
|-----------|------|
| B,S,T,C,H | 各ビットが1なら、そのビットに対応した楽器が選択される。
| V         | 0 = リズム発声。続くデータが音長データ。<br> （読み出し方はメロディ部の音長の場合と同じ）
|           | 1 = 音量を指定します。続く1バイトが音量データ(0～15)。
| 0FFH      | リズム部のデータの最終コード。

## ユーザー音色データ

```
     |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
====||=====|=====|=====|=====|=====|=====|=====|=====||=====|  
 +0 || AM  | VIB | EG  | KSR |        MULTIPLE       || (M) |  
----||-----+-----+-----+-----+-----------------------||-----|  
 +1 || AM  | VIB | EG  | KSR |        MULTIPLE       || (C) |  
----||-----+-----+-----+-----+-----------------------||-----|  
 +2 ||   KSL(M)  |     TOTAL LEVEL (MODULATOR)       || (M) |  
----||-----------+-----+-----+-----+-----------------||-----|  
 +3 ||   KSL(C)  | --  | DC  | DM  |    FEEDBACK     ||(C/M)|  
----||-----------+-----+-----|-----+-----------------||-----|  
 +4 ||      Attack Rate      |       Decay Rate      || (M) |  
----||-----------------------|-----------------------||-----|  
 +5 ||      Attack Rate      |       Decay Rate      || (C) |  
----||-----------------------|-----------------------||-----|  
 +6 ||     Sustain Level     |      Release Rate     || (C) |  
----||-----------------------|-----------------------||-----|  
 +7 ||     Sustain Level     |      Release Rate     || (C) |  
----||-----------------------|-----------------------||-----|  
```

